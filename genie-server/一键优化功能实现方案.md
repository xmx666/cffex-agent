# ä¸€é”®ä¼˜åŒ–åŠŸèƒ½å®ç°æ–¹æ¡ˆ

## ğŸ“‹ åŠŸèƒ½éœ€æ±‚

å°†"æ·±åº¦æ€è€ƒ"æŒ‰é’®æ”¹ä¸º"ä¸€é”®ä¼˜åŒ–"æŒ‰é’®ï¼Œç‚¹å‡»åï¼š
1. å¯¹ç”¨æˆ·è¾“å…¥çš„é—®é¢˜è¿›è¡Œä¼˜åŒ–ï¼Œå¸®åŠ©agentæ›´å¥½åœ°å›ç­”é—®é¢˜
2. è‡ªåŠ¨é€‰æ‹©éœ€è¦çš„æ¨¡æ¿
3. ä½¿ç”¨ä¸åç«¯ç›¸åŒçš„å¤§æ¨¡å‹é…ç½®

---

## ğŸ¯ å®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆæ¦‚è¿°

1. **å‰ç«¯ä¿®æ”¹**ï¼š
   - å°†"æ·±åº¦æ€è€ƒ"æŒ‰é’®æ”¹ä¸º"ä¸€é”®ä¼˜åŒ–"æŒ‰é’®
   - æ·»åŠ ä¼˜åŒ–é—®é¢˜çš„APIè°ƒç”¨é€»è¾‘
   - æ·»åŠ è‡ªåŠ¨é€‰æ‹©æ¨¡æ¿çš„é€»è¾‘

2. **åç«¯æ–°å¢API**ï¼ˆæˆ–å‰ç«¯ç›´æ¥è°ƒç”¨LLMï¼‰ï¼š
   - åˆ›å»ºä¸€ä¸ªä¼˜åŒ–é—®é¢˜çš„APIç«¯ç‚¹
   - ä½¿ç”¨ä¸åç«¯ç›¸åŒçš„LLMé…ç½®

3. **ä¼˜åŒ–æµç¨‹**ï¼š
   ```
   ç”¨æˆ·è¾“å…¥é—®é¢˜ â†’ ç‚¹å‡»"ä¸€é”®ä¼˜åŒ–" â†’ 
   è°ƒç”¨LLMä¼˜åŒ–é—®é¢˜ â†’ 
   åˆ†æé—®é¢˜å¹¶æ¨èæ¨¡æ¿ â†’ 
   æ›´æ–°è¾“å…¥æ¡†å’Œæ¨¡æ¿é€‰æ‹© â†’ 
   ç”¨æˆ·ç¡®è®¤åå‘é€
   ```

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. LLMé…ç½®ï¼ˆä¸åç«¯ä¿æŒä¸€è‡´ï¼‰

**åç«¯é…ç½®**ï¼ˆ`application.yml`ï¼‰ï¼š
```yaml
llm:
  default:
    base_url: 'http://172.26.36.12:80/futuremaas/v1'
    apikey: 'cffex-pnnpdqex7gv9gt1m'
    interface_url: '/chat/completions'
    model: 'qwen3-next-80b-fp8-local'
    max_tokens: 100000
  settings: '{"qwen3-next-80b-fp8-local":{"model":"qwen3-next-80b-fp8-local","max_tokens":100000,"temperature":0,"top_p":0.1,"base_url":"http://172.26.36.12:80/futuremaas/v1","apikey":"cffex-pnnpdqex7gv9gt1m","interface_url":"/chat/completions","max_input_tokens":256000}}'
```

**å‰ç«¯éœ€è¦ä½¿ç”¨çš„é…ç½®**ï¼š
- base_url: `http://172.26.36.12:80/futuremaas/v1`
- apikey: `cffex-pnnpdqex7gv9gt1m`
- interface_url: `/chat/completions`
- model: `qwen3-next-80b-fp8-local`
- temperature: `0`
- top_p: `0.1`
- max_tokens: `100000`

---

### 2. ä¼˜åŒ–é—®é¢˜çš„Promptè®¾è®¡

**ä¼˜åŒ–é—®é¢˜çš„Prompt**ï¼š
```
ä½ æ˜¯ä¸€ä¸ªé—®é¢˜ä¼˜åŒ–åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·è¾“å…¥çš„é—®é¢˜ï¼Œä¼˜åŒ–é—®é¢˜è¡¨è¿°ï¼Œä½¿å…¶æ›´åŠ æ¸…æ™°ã€å…·ä½“ã€æ˜“äºç†è§£å’Œå›ç­”ã€‚

ä¼˜åŒ–åŸåˆ™ï¼š
1. ä¿æŒåŸé—®é¢˜çš„æ ¸å¿ƒæ„å›¾ä¸å˜
2. ä½¿é—®é¢˜æ›´åŠ å…·ä½“å’Œæ˜ç¡®
3. è¡¥å……å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
4. ä½¿ç”¨æ¸…æ™°çš„è¯­è¨€è¡¨è¾¾
5. å¦‚æœé—®é¢˜æ¶‰åŠç‰¹å®šé¢†åŸŸï¼Œä½¿ç”¨è¯¥é¢†åŸŸçš„ä¸“ä¸šæœ¯è¯­

ç”¨æˆ·åŸå§‹é—®é¢˜ï¼š
{userQuestion}

è¯·è¾“å‡ºä¼˜åŒ–åçš„é—®é¢˜ï¼ˆåªè¾“å‡ºä¼˜åŒ–åçš„é—®é¢˜ï¼Œä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šï¼‰ï¼š
```

**æ¨¡æ¿æ¨èçš„Prompt**ï¼š
```
ä½ æ˜¯ä¸€ä¸ªæ¨¡æ¿æ¨èåŠ©æ‰‹ã€‚æ ¹æ®ç”¨æˆ·çš„é—®é¢˜ï¼Œä»ä»¥ä¸‹æ¨¡æ¿åˆ—è¡¨ä¸­é€‰æ‹©æœ€ç›¸å…³çš„æ¨¡æ¿ï¼ˆå¯ä»¥å¤šé€‰ï¼Œç”¨é€—å·åˆ†éš”æ¨¡æ¿IDï¼‰ã€‚

å¯ç”¨æ¨¡æ¿åˆ—è¡¨ï¼š
{templateList}

ç”¨æˆ·é—®é¢˜ï¼š
{optimizedQuestion}

è¯·åˆ†æé—®é¢˜ç±»å‹å’Œéœ€æ±‚ï¼Œæ¨èæœ€ç›¸å…³çš„æ¨¡æ¿IDï¼ˆåªè¾“å‡ºæ¨¡æ¿IDï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼štemplate1,template2ï¼‰ï¼š
```

---

### 3. å‰ç«¯å®ç°æ­¥éª¤

#### æ­¥éª¤1ï¼šåˆ›å»ºLLMå·¥å…·ç±»

**æ–‡ä»¶**ï¼š`genie-server/genie/ui/src/utils/llmOptimizer.ts`

```typescript
/**
 * LLMä¼˜åŒ–å·¥å…·
 * ä½¿ç”¨ä¸åç«¯ç›¸åŒçš„LLMé…ç½®
 */

interface LLMConfig {
  base_url: string;
  apikey: string;
  interface_url: string;
  model: string;
  temperature: number;
  top_p: number;
  max_tokens: number;
}

// ä¸åç«¯é…ç½®ä¿æŒä¸€è‡´
const LLM_CONFIG: LLMConfig = {
  base_url: 'http://172.26.36.12:80/futuremaas/v1',
  apikey: 'cffex-pnnpdqex7gv9gt1m',
  interface_url: '/chat/completions',
  model: 'qwen3-next-80b-fp8-local',
  temperature: 0,
  top_p: 0.1,
  max_tokens: 100000
};

interface ChatMessage {
  role: 'system' | 'user' | 'assistant';
  content: string;
}

/**
 * è°ƒç”¨LLM API
 */
async function callLLM(messages: ChatMessage[]): Promise<string> {
  const url = `${LLM_CONFIG.base_url}${LLM_CONFIG.interface_url}`;
  
  const response = await fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${LLM_CONFIG.apikey}`
    },
    body: JSON.stringify({
      model: LLM_CONFIG.model,
      messages: messages,
      temperature: LLM_CONFIG.temperature,
      top_p: LLM_CONFIG.top_p,
      max_tokens: LLM_CONFIG.max_tokens
    })
  });

  if (!response.ok) {
    throw new Error(`LLM APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
  }

  const data = await response.json();
  return data.choices[0]?.message?.content || '';
}

/**
 * ä¼˜åŒ–ç”¨æˆ·é—®é¢˜
 */
export async function optimizeQuestion(userQuestion: string): Promise<string> {
  const prompt = `ä½ æ˜¯ä¸€ä¸ªé—®é¢˜ä¼˜åŒ–åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·è¾“å…¥çš„é—®é¢˜ï¼Œä¼˜åŒ–é—®é¢˜è¡¨è¿°ï¼Œä½¿å…¶æ›´åŠ æ¸…æ™°ã€å…·ä½“ã€æ˜“äºç†è§£å’Œå›ç­”ã€‚

ä¼˜åŒ–åŸåˆ™ï¼š
1. ä¿æŒåŸé—®é¢˜çš„æ ¸å¿ƒæ„å›¾ä¸å˜
2. ä½¿é—®é¢˜æ›´åŠ å…·ä½“å’Œæ˜ç¡®
3. è¡¥å……å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
4. ä½¿ç”¨æ¸…æ™°çš„è¯­è¨€è¡¨è¾¾
5. å¦‚æœé—®é¢˜æ¶‰åŠç‰¹å®šé¢†åŸŸï¼Œä½¿ç”¨è¯¥é¢†åŸŸçš„ä¸“ä¸šæœ¯è¯­

ç”¨æˆ·åŸå§‹é—®é¢˜ï¼š
${userQuestion}

è¯·è¾“å‡ºä¼˜åŒ–åçš„é—®é¢˜ï¼ˆåªè¾“å‡ºä¼˜åŒ–åçš„é—®é¢˜ï¼Œä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šï¼‰ï¼š`;

  const messages: ChatMessage[] = [
    {
      role: 'user',
      content: prompt
    }
  ];

  try {
    const optimizedQuestion = await callLLM(messages);
    // æ¸…ç†å¯èƒ½çš„æ ¼å¼é—®é¢˜
    return optimizedQuestion.trim().replace(/^ä¼˜åŒ–åçš„é—®é¢˜[ï¼š:]\s*/i, '');
  } catch (error) {
    console.error('ä¼˜åŒ–é—®é¢˜å¤±è´¥:', error);
    throw error;
  }
}

/**
 * æ¨èç›¸å…³æ¨¡æ¿
 */
export async function recommendTemplates(
  optimizedQuestion: string,
  availableTemplates: Array<{ id: string; name: string; description?: string; domainName?: string }>
): Promise<string[]> {
  if (availableTemplates.length === 0) {
    return [];
  }

  const templateList = availableTemplates.map(t => 
    `- ID: ${t.id}, åç§°: ${t.name}, é¢†åŸŸ: ${t.domainName || 'é€šç”¨'}, æè¿°: ${t.description || 'æ— '}`
  ).join('\n');

  const prompt = `ä½ æ˜¯ä¸€ä¸ªæ¨¡æ¿æ¨èåŠ©æ‰‹ã€‚æ ¹æ®ç”¨æˆ·çš„é—®é¢˜ï¼Œä»ä»¥ä¸‹æ¨¡æ¿åˆ—è¡¨ä¸­é€‰æ‹©æœ€ç›¸å…³çš„æ¨¡æ¿ï¼ˆå¯ä»¥å¤šé€‰ï¼Œç”¨é€—å·åˆ†éš”æ¨¡æ¿IDï¼‰ã€‚

å¯ç”¨æ¨¡æ¿åˆ—è¡¨ï¼š
${templateList}

ç”¨æˆ·é—®é¢˜ï¼š
${optimizedQuestion}

è¯·åˆ†æé—®é¢˜ç±»å‹å’Œéœ€æ±‚ï¼Œæ¨èæœ€ç›¸å…³çš„æ¨¡æ¿IDï¼ˆåªè¾“å‡ºæ¨¡æ¿IDï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼štemplate1,template2ï¼Œå¦‚æœæ²¡æœ‰åˆé€‚çš„æ¨¡æ¿åˆ™è¾“å‡º"æ— "ï¼‰ï¼š`;

  const messages: ChatMessage[] = [
    {
      role: 'user',
      content: prompt
    }
  ];

  try {
    const result = await callLLM(messages);
    const templateIds = result.trim().replace(/^æ¨èçš„æ¨¡æ¿[ï¼š:]\s*/i, '');
    
    if (templateIds === 'æ— ' || !templateIds) {
      return [];
    }

    // è§£ææ¨¡æ¿IDåˆ—è¡¨
    const ids = templateIds.split(',').map(id => id.trim()).filter(id => id);
    // éªŒè¯æ¨¡æ¿IDæ˜¯å¦æœ‰æ•ˆ
    const validIds = ids.filter(id => 
      availableTemplates.some(t => t.id === id)
    );
    
    return validIds;
  } catch (error) {
    console.error('æ¨èæ¨¡æ¿å¤±è´¥:', error);
    return [];
  }
}
```

---

#### æ­¥éª¤2ï¼šä¿®æ”¹GeneralInputç»„ä»¶

**æ–‡ä»¶**ï¼š`genie-server/genie/ui/src/components/GeneralInput/index.tsx`

**ä¿®æ”¹ç‚¹**ï¼š
1. å°†"æ·±åº¦æ€è€ƒ"æŒ‰é’®æ”¹ä¸º"ä¸€é”®ä¼˜åŒ–"
2. æ·»åŠ ä¼˜åŒ–çŠ¶æ€ï¼ˆloadingï¼‰
3. æ·»åŠ ä¼˜åŒ–é—®é¢˜çš„é€»è¾‘
4. æ·»åŠ å›è°ƒå‡½æ•°æ¥æ”¶ä¼˜åŒ–åçš„é—®é¢˜å’Œæ¨¡æ¿

**å…³é”®ä¿®æ”¹**ï¼š
```typescript
// æ·»åŠ props
type Props = {
  // ... ç°æœ‰props
  onOptimize?: (optimizedQuestion: string, recommendedTemplates: string[]) => void;
  availableTemplates?: Array<{ id: string; name: string; description?: string; domainName?: string }>;
};

// æ·»åŠ çŠ¶æ€
const [isOptimizing, setIsOptimizing] = useState<boolean>(false);

// ä¼˜åŒ–å‡½æ•°
const handleOptimize = async () => {
  if (!question.trim() || isOptimizing) {
    return;
  }

  setIsOptimizing(true);
  try {
    const { optimizeQuestion, recommendTemplates } = await import('@/utils/llmOptimizer');
    const optimized = await optimizeQuestion(question);
    
    let recommendedTemplateIds: string[] = [];
    if (props.availableTemplates && props.availableTemplates.length > 0) {
      recommendedTemplateIds = await recommendTemplates(optimized, props.availableTemplates);
    }

    // è°ƒç”¨å›è°ƒå‡½æ•°
    if (props.onOptimize) {
      props.onOptimize(optimized, recommendedTemplateIds);
    }
  } catch (error) {
    console.error('ä¼˜åŒ–å¤±è´¥:', error);
    message.error('ä¼˜åŒ–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
  } finally {
    setIsOptimizing(false);
  }
};

// ä¿®æ”¹æŒ‰é’®
<Button
  color={isOptimizing ? "primary" : "default"}
  variant="outlined"
  className={classNames(
    "text-[12px] p-[8px] h-[28px] transition-all hover:text-[#333] hover:bg-[rgba(64,64,255,0.02)] hover:border-[rgba(64,64,255,0.2)]",
    isOptimizing && "opacity-50 cursor-not-allowed"
  )}
  onClick={handleOptimize}
  disabled={isOptimizing || !question.trim()}
>
  <i className="font_family icon-shendusikao"></i>
  <span className="ml-[-4px]">{isOptimizing ? 'ä¼˜åŒ–ä¸­...' : 'ä¸€é”®ä¼˜åŒ–'}</span>
</Button>
```

---

#### æ­¥éª¤3ï¼šåˆ›å»ºæ¨¡æ¿ç¡®è®¤Modalç»„ä»¶

**æ–‡ä»¶**ï¼š`genie-server/genie/ui/src/components/TemplateConfirmModal/index.tsx`ï¼ˆæ–°å»ºï¼‰

```typescript
import React from 'react';
import { Modal, Tag, List, Button, Space } from 'antd';
import { CheckOutlined, CloseOutlined } from '@ant-design/icons';

interface TemplateInfo {
  id: string;
  name: string;
  description?: string;
  domainName?: string;
}

interface TemplateConfirmModalProps {
  visible: boolean;
  templates: TemplateInfo[];
  optimizedQuestion: string;
  onConfirm: () => void;
  onCancel: () => void;
}

const TemplateConfirmModal: React.FC<TemplateConfirmModalProps> = ({
  visible,
  templates,
  optimizedQuestion,
  onConfirm,
  onCancel
}) => {
  return (
    <Modal
      title={
        <div className="flex items-center">
          <i className="font_family icon-wendang text-[18px] text-[#4040ff] mr-8"></i>
          <span>æ¨¡æ¿æ¨èç¡®è®¤</span>
        </div>
      }
      open={visible}
      onCancel={onCancel}
      width={600}
      footer={[
        <Button key="cancel" onClick={onCancel} icon={<CloseOutlined />}>
          æš‚ä¸ä½¿ç”¨
        </Button>,
        <Button 
          key="confirm" 
          type="primary" 
          onClick={onConfirm}
          icon={<CheckOutlined />}
          style={{
            background: 'linear-gradient(270deg, rgba(64,64,255,1) 0%, rgba(60,196,250,1) 100%)',
            border: 'none'
          }}
        >
          ä¸€é”®åº”ç”¨æ¨¡æ¿
        </Button>
      ]}
    >
      <div className="py-16">
        <div className="mb-16">
          <div className="text-[14px] text-gray-600 mb-8">ä¼˜åŒ–åçš„é—®é¢˜ï¼š</div>
          <div className="bg-gray-50 p-12 rounded-[8px] text-[14px] text-gray-800 border border-gray-200">
            {optimizedQuestion}
          </div>
        </div>

        <div className="mb-16">
          <div className="text-[14px] text-gray-600 mb-8">
            æ ¹æ®æ‚¨çš„é—®é¢˜ï¼Œæ¨èä»¥ä¸‹æ¨¡æ¿ï¼ˆ{templates.length}ä¸ªï¼‰ï¼š
          </div>
          <List
            dataSource={templates}
            renderItem={(template) => (
              <List.Item className="px-0">
                <div className="w-full">
                  <div className="flex items-center mb-4">
                    <Tag color="blue" className="mr-8">
                      {template.domainName || 'é€šç”¨'}
                    </Tag>
                    <span className="font-[500] text-[14px]">{template.name}</span>
                  </div>
                  {template.description && (
                    <div className="text-[12px] text-gray-500 ml-0">
                      {template.description}
                    </div>
                  )}
                </div>
              </List.Item>
            )}
          />
        </div>

        <div className="bg-blue-50 p-12 rounded-[8px] border border-blue-200">
          <div className="text-[12px] text-blue-700">
            ğŸ’¡ æç¤ºï¼šåº”ç”¨æ¨¡æ¿åï¼Œè¿™äº›æ¨¡æ¿å°†è‡ªåŠ¨æ·»åŠ åˆ°æ‚¨çš„æ¨¡æ¿åˆ—è¡¨ä¸­ï¼Œå¸®åŠ©Agentæ›´å¥½åœ°ç†è§£å’Œå›ç­”æ‚¨çš„é—®é¢˜ã€‚
          </div>
        </div>
      </div>
    </Modal>
  );
};

export default TemplateConfirmModal;
```

---

#### æ­¥éª¤4ï¼šä¿®æ”¹Homeç»„ä»¶

**æ–‡ä»¶**ï¼š`genie-server/genie/ui/src/pages/Home/index.tsx`

**ä¿®æ”¹ç‚¹**ï¼š
1. æ·»åŠ æ¨¡æ¿ç¡®è®¤Modalçš„çŠ¶æ€
2. æ·»åŠ ä¼˜åŒ–å¤„ç†å‡½æ•°ï¼ˆæ˜¾ç¤ºç¡®è®¤æ¡†ï¼‰
3. æ·»åŠ æ¨¡æ¿åº”ç”¨ç¡®è®¤å‡½æ•°
4. ä¼ é€’æ¨¡æ¿åˆ—è¡¨ç»™GeneralInput

**å…³é”®ä¿®æ”¹**ï¼š
```typescript
import TemplateConfirmModal from '@/components/TemplateConfirmModal';

// æ·»åŠ çŠ¶æ€
const [templateConfirmVisible, setTemplateConfirmVisible] = useState(false);
const [recommendedTemplates, setRecommendedTemplates] = useState<Array<{ id: string; name: string; description?: string; domainName?: string }>>([]);
const [optimizedQuestion, setOptimizedQuestion] = useState<string>('');

// ä¼˜åŒ–å¤„ç†å‡½æ•°ï¼ˆæ˜¾ç¤ºç¡®è®¤æ¡†ï¼‰
const handleOptimize = useCallback((optimizedQuestion: string, recommendedTemplateIds: string[]) => {
  // æ›´æ–°è¾“å…¥æ¡†å†…å®¹
  setInputInfo(prev => ({
    ...prev,
    message: optimizedQuestion
  }));

  // ä¿å­˜ä¼˜åŒ–åçš„é—®é¢˜
  setOptimizedQuestion(optimizedQuestion);

  // å¦‚æœæœ‰æ¨èçš„æ¨¡æ¿ï¼Œæ˜¾ç¤ºç¡®è®¤æ¡†
  if (recommendedTemplateIds.length > 0) {
    // è·å–æ¨èçš„æ¨¡æ¿è¯¦ç»†ä¿¡æ¯
    const recommendedTemplatesInfo = recommendedTemplateIds
      .map(id => {
        const template = templateConfig.templateList.find(t => t.id === id);
        if (template) {
          const domain = templateConfig.domains.find(d => d.id === template.domainId);
          return {
            id: template.id,
            name: template.name,
            description: template.description,
            domainName: domain?.name
          };
        }
        return null;
      })
      .filter(t => t !== null) as Array<{ id: string; name: string; description?: string; domainName?: string }>;

    setRecommendedTemplates(recommendedTemplatesInfo);
    setTemplateConfirmVisible(true);
  } else {
    message.success('é—®é¢˜å·²ä¼˜åŒ–ï¼Œæœªæ‰¾åˆ°ç›¸å…³æ¨¡æ¿');
  }
}, [templateConfig]);

// ç¡®è®¤åº”ç”¨æ¨¡æ¿
const handleConfirmTemplates = useCallback(() => {
  if (recommendedTemplates.length === 0) {
    return;
  }

  const recommendedTemplateIds = recommendedTemplates.map(t => t.id);
  const currentSelectedIds = globalTemplateManager.getUserSelectedTemplateIds();
  const newSelectedIds = [...new Set([...currentSelectedIds, ...recommendedTemplateIds])];
  
  globalTemplateManager.setUserSelectedTemplateIds(newSelectedIds);
  
  // è§¦å‘æ¨¡æ¿æ›´æ–°äº‹ä»¶
  window.dispatchEvent(new Event('userSelectedTemplatesChange'));
  
  // åˆ·æ–°æ¨¡æ¿æ˜¾ç¤º
  loadUserSelectedTemplates();
  
  setTemplateConfirmVisible(false);
  message.success(`å·²æˆåŠŸåº”ç”¨ ${recommendedTemplates.length} ä¸ªæ¨èæ¨¡æ¿`);
}, [recommendedTemplates]);

// å–æ¶ˆåº”ç”¨æ¨¡æ¿
const handleCancelTemplates = useCallback(() => {
  setTemplateConfirmVisible(false);
  message.info('å·²è·³è¿‡æ¨¡æ¿åº”ç”¨ï¼Œæ‚¨å¯ä»¥ç¨ååœ¨æ¨¡æ¿è®¾ç½®ä¸­æ‰‹åŠ¨é€‰æ‹©');
}, []);

// åœ¨renderä¸­æ·»åŠ TemplateConfirmModal
<TemplateConfirmModal
  visible={templateConfirmVisible}
  templates={recommendedTemplates}
  optimizedQuestion={optimizedQuestion}
  onConfirm={handleConfirmTemplates}
  onCancel={handleCancelTemplates}
/>

// åœ¨GeneralInputç»„ä»¶ä¸­ä¼ é€’props
<GeneralInput
  // ... ç°æœ‰props
  onOptimize={handleOptimize}
  availableTemplates={templateConfig.templateList.map(t => {
    const domain = templateConfig.domains.find(d => d.id === t.domainId);
    return {
      id: t.id,
      name: t.name,
      description: t.description,
      domainName: domain?.name
    };
  })}
/>
```

---

#### æ­¥éª¤4ï¼šä¿®æ”¹ChatViewç»„ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰

å¦‚æœChatViewä¸­ä¹Ÿä½¿ç”¨äº†GeneralInputï¼Œéœ€è¦åŒæ ·çš„ä¿®æ”¹ã€‚

---

## ğŸ”„ å·¥ä½œæµç¨‹

1. **ç”¨æˆ·è¾“å…¥é—®é¢˜** â†’ åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥é—®é¢˜
2. **ç‚¹å‡»"ä¸€é”®ä¼˜åŒ–"** â†’ è§¦å‘ä¼˜åŒ–æµç¨‹
3. **è°ƒç”¨LLMä¼˜åŒ–é—®é¢˜** â†’ ä½¿ç”¨ä¸åç«¯ç›¸åŒçš„LLMé…ç½®
4. **åˆ†æå¹¶æ¨èæ¨¡æ¿** â†’ æ ¹æ®ä¼˜åŒ–åçš„é—®é¢˜æ¨èç›¸å…³æ¨¡æ¿
5. **æ˜¾ç¤ºæ¨¡æ¿ç¡®è®¤æ¡†** â†’ 
   - å¦‚æœæ¨èäº†æ¨¡æ¿ï¼Œæ˜¾ç¤ºç¡®è®¤Modal
   - å±•ç¤ºæ¨èçš„æ¨¡æ¿ä¿¡æ¯ï¼ˆåç§°ã€é¢†åŸŸã€æè¿°ï¼‰
   - ç”¨æˆ·å¯ä»¥é€‰æ‹©"æ˜¯"åº”ç”¨æ¨¡æ¿ï¼Œæˆ–"å¦"è·³è¿‡
6. **åº”ç”¨æ¨¡æ¿ï¼ˆå¦‚æœç”¨æˆ·é€‰æ‹©"æ˜¯"ï¼‰** â†’ 
   - è‡ªåŠ¨é€‰æ‹©æ¨èçš„æ¨¡æ¿
   - æ›´æ–°æ¨¡æ¿é€‰æ‹©çŠ¶æ€
   - æ˜¾ç¤ºæˆåŠŸæç¤º
7. **æ›´æ–°UI** â†’ 
   - è¾“å…¥æ¡†æ˜¾ç¤ºä¼˜åŒ–åçš„é—®é¢˜
   - å¦‚æœåº”ç”¨äº†æ¨¡æ¿ï¼Œæ˜¾ç¤ºå·²é€‰æ‹©çš„æ¨¡æ¿æ ‡ç­¾
8. **ç”¨æˆ·ç¡®è®¤å‘é€** â†’ ç”¨æˆ·å¯ä»¥ä¿®æ”¹åå‘é€ï¼Œæˆ–ç›´æ¥å‘é€

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. CORSé—®é¢˜
å¦‚æœå‰ç«¯ç›´æ¥è°ƒç”¨LLM APIï¼Œå¯èƒ½ä¼šé‡åˆ°CORSé—®é¢˜ã€‚è§£å†³æ–¹æ¡ˆï¼š
- **æ–¹æ¡ˆA**ï¼šåœ¨åç«¯æ·»åŠ ä»£ç†APIï¼ˆæ¨èï¼‰
- **æ–¹æ¡ˆB**ï¼šé…ç½®LLMæœåŠ¡å™¨çš„CORSç­–ç•¥

### 2. APIå¯†é’¥å®‰å…¨
å‰ç«¯ç›´æ¥ä½¿ç”¨APIå¯†é’¥å­˜åœ¨å®‰å…¨é£é™©ã€‚å»ºè®®ï¼š
- **æ–¹æ¡ˆA**ï¼šé€šè¿‡åç«¯ä»£ç†ï¼ŒAPIå¯†é’¥ä¿å­˜åœ¨åç«¯ï¼ˆæ¨èï¼‰
- **æ–¹æ¡ˆB**ï¼šå¦‚æœå¿…é¡»å‰ç«¯è°ƒç”¨ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œä¸è¦ç¡¬ç¼–ç 

### 3. é”™è¯¯å¤„ç†
- ç½‘ç»œé”™è¯¯
- LLM APIé”™è¯¯
- è¶…æ—¶å¤„ç†ï¼ˆå»ºè®®è®¾ç½®30ç§’è¶…æ—¶ï¼‰

### 4. ç”¨æˆ·ä½“éªŒ
- æ˜¾ç¤ºåŠ è½½çŠ¶æ€
- ä¼˜åŒ–å¤±è´¥æ—¶ç»™å‡ºå‹å¥½æç¤º
- å…è®¸ç”¨æˆ·å–æ¶ˆä¼˜åŒ–

---

## ğŸš€ æ¨èå®ç°æ–¹æ¡ˆï¼ˆåç«¯ä»£ç†ï¼‰

### æ–¹æ¡ˆï¼šåœ¨åç«¯æ·»åŠ ä¼˜åŒ–API

**ä¼˜ç‚¹**ï¼š
- å®‰å…¨æ€§é«˜ï¼ˆAPIå¯†é’¥ä¸æš´éœ²ï¼‰
- é¿å…CORSé—®é¢˜
- ç»Ÿä¸€ç®¡ç†LLMé…ç½®

**å®ç°æ­¥éª¤**ï¼š

1. **åç«¯æ–°å¢Controller**ï¼š
```java
@RestController
@RequestMapping("/api/optimize")
public class QuestionOptimizeController {
    
    @PostMapping("/question")
    public ResponseEntity<?> optimizeQuestion(@RequestBody Map<String, String> request) {
        String userQuestion = request.get("question");
        // è°ƒç”¨LLMä¼˜åŒ–é—®é¢˜
        String optimized = llmService.optimizeQuestion(userQuestion);
        return ResponseEntity.ok(Map.of("optimizedQuestion", optimized));
    }
    
    @PostMapping("/recommend-templates")
    public ResponseEntity<?> recommendTemplates(@RequestBody Map<String, Object> request) {
        String question = (String) request.get("question");
        List<Template> templates = (List<Template>) request.get("templates");
        // è°ƒç”¨LLMæ¨èæ¨¡æ¿
        List<String> recommendedIds = llmService.recommendTemplates(question, templates);
        return ResponseEntity.ok(Map.of("templateIds", recommendedIds));
    }
}
```

2. **å‰ç«¯è°ƒç”¨åç«¯API**ï¼š
```typescript
// ä¿®æ”¹ llmOptimizer.tsï¼Œæ”¹ä¸ºè°ƒç”¨åç«¯API
async function optimizeQuestion(userQuestion: string): Promise<string> {
  const baseUrl = getApiBaseUrl(); // ä½¿ç”¨ç°æœ‰çš„APIåŸºç¡€URL
  const response = await fetch(`${baseUrl}/api/optimize/question`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ question: userQuestion })
  });
  const data = await response.json();
  return data.optimizedQuestion;
}
```

---

## ğŸ“ å®æ–½è®¡åˆ’

### é˜¶æ®µ1ï¼šå‰ç«¯åŸºç¡€åŠŸèƒ½ï¼ˆ1-2å¤©ï¼‰
1. âœ… åˆ›å»ºLLMå·¥å…·ç±»ï¼ˆæˆ–è°ƒç”¨åç«¯APIï¼‰
2. âœ… åˆ›å»ºæ¨¡æ¿ç¡®è®¤Modalç»„ä»¶
3. âœ… ä¿®æ”¹GeneralInputç»„ä»¶
4. âœ… ä¿®æ”¹Homeç»„ä»¶ï¼ˆæ·»åŠ ç¡®è®¤æ¡†é€»è¾‘ï¼‰
5. âœ… æµ‹è¯•ä¼˜åŒ–åŠŸèƒ½å’Œæ¨¡æ¿ç¡®è®¤æµç¨‹

### é˜¶æ®µ2ï¼šåç«¯APIï¼ˆå¦‚æœé‡‡ç”¨åç«¯ä»£ç†æ–¹æ¡ˆï¼‰ï¼ˆ1-2å¤©ï¼‰
1. âœ… åˆ›å»ºä¼˜åŒ–Controller
2. âœ… å®ç°LLMè°ƒç”¨é€»è¾‘
3. âœ… æµ‹è¯•API

### é˜¶æ®µ3ï¼šä¼˜åŒ–å’Œæµ‹è¯•ï¼ˆ1å¤©ï¼‰
1. âœ… ä¼˜åŒ–Prompt
2. âœ… é”™è¯¯å¤„ç†
3. âœ… ç”¨æˆ·ä½“éªŒä¼˜åŒ–
4. âœ… å®Œæ•´æµ‹è¯•

---

## ğŸ¨ UI/UXå»ºè®®

1. **æŒ‰é’®çŠ¶æ€**ï¼š
   - é»˜è®¤ï¼šæ˜¾ç¤º"ä¸€é”®ä¼˜åŒ–"
   - åŠ è½½ä¸­ï¼šæ˜¾ç¤º"ä¼˜åŒ–ä¸­..."ï¼Œç¦ç”¨æŒ‰é’®
   - ä¼˜åŒ–å®Œæˆï¼šæ˜¾ç¤ºæˆåŠŸæç¤º

2. **ä¼˜åŒ–ç»“æœå±•ç¤º**ï¼š
   - ç›´æ¥æ›¿æ¢è¾“å…¥æ¡†å†…å®¹ï¼Œæ˜¾ç¤ºä¼˜åŒ–åçš„é—®é¢˜
   - å¦‚æœæ¨èäº†æ¨¡æ¿ï¼Œæ˜¾ç¤ºç¡®è®¤Modal

3. **æ¨¡æ¿ç¡®è®¤Modalè®¾è®¡**ï¼š
   - **æ ‡é¢˜**ï¼šæ˜¾ç¤º"æ¨¡æ¿æ¨èç¡®è®¤"å›¾æ ‡å’Œæ–‡å­—
   - **ä¼˜åŒ–åçš„é—®é¢˜åŒºåŸŸ**ï¼š
     - æ˜¾ç¤ºä¼˜åŒ–åçš„é—®é¢˜å†…å®¹
     - ä½¿ç”¨ç°è‰²èƒŒæ™¯æ¡†çªå‡ºæ˜¾ç¤º
   - **æ¨èæ¨¡æ¿åˆ—è¡¨**ï¼š
     - æ˜¾ç¤ºæ¯ä¸ªæ¨¡æ¿çš„åç§°ã€é¢†åŸŸæ ‡ç­¾ã€æè¿°
     - ä½¿ç”¨Listç»„ä»¶å±•ç¤ºï¼Œæ¸…æ™°æ˜“è¯»
   - **æç¤ºä¿¡æ¯**ï¼š
     - è¯´æ˜åº”ç”¨æ¨¡æ¿çš„ä½œç”¨å’Œå¥½å¤„
   - **æ“ä½œæŒ‰é’®**ï¼š
     - "æš‚ä¸ä½¿ç”¨"ï¼šå–æ¶ˆåº”ç”¨æ¨¡æ¿
     - "ä¸€é”®åº”ç”¨æ¨¡æ¿"ï¼šç¡®è®¤åº”ç”¨æ¨èçš„æ¨¡æ¿ï¼ˆä½¿ç”¨æ¸å˜è‰²æŒ‰é’®ï¼‰

4. **æ¨¡æ¿åº”ç”¨åæç¤º**ï¼š
   - æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ï¼š"å·²æˆåŠŸåº”ç”¨Xä¸ªæ¨èæ¨¡æ¿"
   - åœ¨æ¨¡æ¿æ ‡ç­¾åŒºåŸŸæ˜¾ç¤ºæ–°é€‰æ‹©çš„æ¨¡æ¿
   - å¦‚æœç”¨æˆ·é€‰æ‹©"æš‚ä¸ä½¿ç”¨"ï¼Œæ˜¾ç¤ºæç¤ºï¼š"å·²è·³è¿‡æ¨¡æ¿åº”ç”¨ï¼Œæ‚¨å¯ä»¥ç¨ååœ¨æ¨¡æ¿è®¾ç½®ä¸­æ‰‹åŠ¨é€‰æ‹©"

---

**æœ€åæ›´æ–°**ï¼š2025-12-17

