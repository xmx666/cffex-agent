Html:
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>慢查询性能优化深度分析报告</title>
    <link rel="stylesheet" href="/static-resources/tailwindcss/tailwind.min.css">
    <link rel="stylesheet" href="/static-resources/font-awesome/all.min.css">
    <link href="/static-resources/googleapis-fonts/css2.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        .section-header {
            border-left: 4px solid #007bff;
            padding-left: 1rem;
            margin: 2rem 0 1.5rem 0;
        }
        .card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-high {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        .badge-medium {
            background-color: #fffbe6;
            color: #d97706;
        }
        .badge-low {
            background-color: #e0f2fe;
            color: #0891b2;
        }
        .table-container {
            overflow-x: auto;
            margin: 1rem 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background-color: #f3f4f6;
            font-weight: 600;
            color: #374151;
        }
        tr:hover {
            background-color: #f9fafb;
        }
        .code-block {
            background-color: #f1f5f9;
            padding: 1rem;
            border-radius: 0.375rem;
            overflow-x: auto;
            font-family: 'Courier New', Courier, monospace;
            margin: 1rem 0;
            border-left: 3px solid #007bff;
        }
        .progress-bar {
            height: 0.5rem;
            background-color: #e0e0e0;
            border-radius: 9999px;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            border-radius: 9999px;
        }
        .footer {
            margin-top: 3rem;
            text-align: center;
            color: #6b7280;
            font-size: 0.875rem;
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        .collapsible {
            cursor: pointer;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid #e5e7eb;
        }
        .collapsible-content {
            display: none;
            padding: 1rem;
            background-color: white;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            border-top: none;
        }
        .collapsible.active + .collapsible-content {
            display: block;
        }
        .collapsible::after {
            content: '\\f078';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            float: right;
            transition: transform 0.3s;
        }
        .collapsible.active::after {
            content: '\\f077';
        }
        .highlight {
            background-color: #fff3cd;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 500;
        }
    </style>
</head>
<body class="max-w-6xl mx-auto px-4 py-8">
    <header class="text-center mb-10">
        <h1 class="text-4xl font-bold text-gray-800 mb-4">慢查询性能优化深度分析报告</h1>
        <p class="text-lg text-gray-600">基于2025年12月5日至12月12日的慢查询分析数据</p>
        <p class="text-sm text-gray-500 mt-2">分析周期：7天 | 分析时间戳：2025-12-12T02:43:32.694646</p>
    </header>

    <section class="section-header">
        <h2 class="text-2xl font-bold text-gray-800">1. 慢查询核心问题总结</h2>
    </section>
    <div class="card">
        <p class="mb-4">在为期7天的慢查询分析周期内，共识别出53条执行时间超过1000毫秒的慢查询，其中98%为SELECT语句。通过对查询模式的深度分析，发现三大核心性能瓶颈：</p>
        
        <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-3 flex items-center">
                <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                1. 高频使用 SELECT * 操作
            </h3>
            <p class="mb-3">在53条慢查询中，有28条（占比52.8%）使用了 <code class="bg-gray-100 px-2 py-1 rounded">SELECT *</code> 语法，这种模式强制数据库扫描所有列，即使仅需少量字段，极大增加了I/O负载和网络传输开销。</p>
            <p class="mb-3">典型示例：</p>
            <div class="code-block">
                SELECT * FROM cai_api_use WHERE api_key="cffex-7seuwe00no67ocg1" AND token=0 AND completion_token=0 AND prompt_token=0 ORDER BY update_time DESC
            </div>
            <p class="mt-2"><span class="badge badge-high">高风险</span> 此类查询在 <code class="highlight">cai_api_use</code> 表上执行，该表包含 <code class="highlight">text</code> 类型的 <code class="highlight">question</code> 和 <code class="highlight">response</code> 字段，单行数据体积可达数KB，全列扫描导致资源浪费严重。</p>
        </div>

        <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-3 flex items-center">
                <i class="fas fa-chart-line text-orange-500 mr-2"></i>
                2. 大规模数据扫描
            </h3>
            <p class="mb-3">分析显示，慢查询平均扫描字节数达 3.98GB，最大单次扫描高达 37.55GB（扫描行数335万+），远超合理范围。主要扫描表为 <code class="highlight">ods_telemetry.cai_api_use</code> 和 <code class="highlight">dwd_telemetry.application_futuremaas_api_use_detail_metrics</code>。</p>
            <p class="mb-3">典型扫描模式：</p>
            <div class="code-block">
                SELECT SUBSTRING(CAST(MIN(`full_question`) AS STRING), 1, 1024) as min, SUBSTRING(CAST(MAX(`full_question`) AS STRING), 1, 1024) as max FROM `ods_telemetry`.`cai_api_use`
            </div>
            <p class="mb-3">此类查询虽仅需聚合结果，但因缺乏有效过滤条件，导致全表扫描。总扫描字节数达 199.07GB，占系统总I/O负载的显著比例。</p>
        </div>

        <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-3 flex items-center">
                <i class="fas fa-ban text-blue-500 mr-2"></i>
                3. 无索引排序与过滤
            </h3>
            <p class="mb-3">在28条使用 <code class="highlight">SELECT *</code> 的查询中，有4条（占比14.3%）包含 <code class="highlight">ORDER BY update_time DESC</code> 且无对应索引，导致数据库执行全表排序（Filesort），消耗大量CPU和内存资源。</p>
            <p class="mb-3">此外，24条查询存在 <code class="highlight">inefficient_filtering</code> 问题，主要表现为：</p>
            <ul class="list-disc list-inside mb-3 ml-6">
                <li>对 <code class="highlight">response</code> 字段使用 <code class="highlight">LIKE \"%服务异常%\"</code> 等前导通配符模糊查询，无法利用索引</li>
                <li>未使用分区字段（如时间）进行范围过滤</li>
                <li>对高基数文本字段进行全表扫描以匹配关键词</li>
            </ul>
            <p class="mb-3">例如：</p>
            <div class="code-block">
                SELECT * FROM cai_api_use WHERE response LIKE \"%服务异常%\" ORDER BY update_time DESC
            </div>
            <p class="mt-2">此类查询在扫描1738MB数据后仅返回2694行，效率极低。</p>
        </div>
    </div>

    <section class="section-header">
        <h2 class="text-2xl font-bold text-gray-800">2. 高频访问表 ods_telemetry.cai_api_use 字段分析</h2>
    </section>
    <div class="card">
        <p class="mb-4">根据慢查询分析结果，<code class="highlight">ods_telemetry.cai_api_use</code> 是最频繁被访问的慢查询目标表，共被8次慢查询引用，是性能瓶颈的核心焦点。该表结构如下：</p>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>字段名</th>
                        <th>数据类型</th>
                        <th>是否可空</th>
                        <th>是否为键</th>
                        <th>备注</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>update_time</td>
                        <td>datetime</td>
                        <td>否</td>
                        <td>是</td>
                        <td>主键，用于排序和时间过滤</td>
                    </tr>
                    <tr>
                        <td>user_name</td>
                        <td>varchar(256)</td>
                        <td>否</td>
                        <td>是</td>
                        <td>用户标识</td>
                    </tr>
                    <tr>
                        <td>department</td>
                        <td>varchar(256)</td>
                        <td>否</td>
                        <td>否</td>
                        <td>部门信息</td>
                    </tr>
                    <tr>
                        <td>services</td>
                        <td>varchar(256)</td>
                        <td>否</td>
                        <td>否</td>
                        <td>服务名称</td>
                    </tr>
                    <tr>
                        <td>model_name</td>
                        <td>varchar(256)</td>
                        <td>否</td>
                        <td>否</td>
                        <td>模型名称</td>
                    </tr>
                    <tr>
                        <td>endpoint</td>
                        <td>varchar(256)</td>
                        <td>否</td>
                        <td>否</td>
                        <td>API端点</td>
                    </tr>
                    <tr>
                        <td>api_key</td>
                        <td>varchar(256)</td>
                        <td>否</td>
                        <td>否</td>
                        <td>API密钥，用于权限控制</td>
                    </tr>
                    <tr>
                        <td>latency</td>
                        <td>decimal(10,2)</td>
                        <td>否</td>
                        <td>否</td>
                        <td>响应延迟</td>
                    </tr>
                    <tr>
                        <td>token</td>
                        <td>int</td>
                        <td>否</td>
                        <td>否</td>
                        <td>总token数</td>
                    </tr>
                    <tr>
                        <td>prompt_token</td>
                        <td>int</td>
                        <td>否</td>
                        <td>否</td>
                        <td>提示词token数</td>
                    </tr>
                    <tr>
                        <td>completion_token</td>
                        <td>int</td>
                        <td>否</td>
                        <td>否</td>
                        <td>补全token数</td>
                    </tr>
                    <tr>
                        <td>question</td>
                        <td>text</td>
                        <td>否</td>
                        <td>否</td>
                        <td>用户提问内容，文本量大</td>
                    </tr>
                    <tr>
                        <td>response</td>
                        <td>text</td>
                        <td>否</td>
                        <td>否</td>
                        <td>系统响应内容，文本量大</td>
                    </tr>
                    <tr>
                        <td>full_question</td>
                        <td>text</td>
                        <td>否</td>
                        <td>否</td>
                        <td>完整提问上下文，文本量大</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="mt-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">关键字段使用模式分析</h3>
            <ul class="list-disc list-inside mb-4">
                <li><strong>update_time</strong>：在4条慢查询中用于排序，但无索引，导致全表排序</li>
                <li><strong>api_key</strong>：在2条慢查询中作为精确匹配条件（如 <code class="highlight">api_key="cffex-7seuwe00no67ocg1"</code>），但未建立索引</li>
                <li><strong>response</strong>：在2条慢查询中使用 <code class="highlight">LIKE \"%服务异常%\"</code> 和 <code class="highlight">LIKE \"%调用异常%\"</code> 进行模糊匹配，因文本字段特性，无法使用B-tree索引优化</li>
                <li><strong>question / full_question</strong>：在6条慢查询中被用于 <code class="highlight">MIN()</code> / <code class="highlight">MAX()</code> 聚合，需全表扫描text字段，效率极低</li>
            </ul>
            <p class="mb-3">该表数据量级大，且包含多个大文本字段，是导致“大表扫描”和“长执行时间”的根本原因。</p>
        </div>
    </div>

    <section class="section-header">
        <h2 class="text-2xl font-bold text-gray-800">3. 索引优化建议</h2>
    </section>
    <div class="card">
        <p class="mb-4">基于对慢查询模式和表结构的分析，提出以下针对性索引优化方案：</p>

        <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">3.1 为 update_time 建立索引</h3>
            <p class="mb-3">当前所有使用 <code class="highlight">ORDER BY update_time DESC</code> 的查询均执行全表排序，消耗大量资源。建议创建复合索引以同时优化排序和过滤。</p>
            <div class="code-block">
                CREATE INDEX idx_cai_api_use_update_time ON ods_telemetry.cai_api_use(update_time DESC);
            </div>
            <p class="mt-2">此索引将使排序操作从 O(n log n) 降为 O(log n)，并可被用于时间范围查询（如 WHERE update_time > '2025-12-11 14:00:00'）。</p>
        </div>

        <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">3.2 为 api_key 建立索引</h3>
            <p class="mb-3">在慢查询中，<code class="highlight">api_key</code> 被用作精确匹配条件，且其基数高（唯一性好），是理想的索引候选字段。</p>
            <div class="code-block">
                CREATE INDEX idx_cai_api_use_api_key ON ods_telemetry.cai_api_use(api_key);
            </div>
            <p class="mt-2">此索引可将查询 <code class="highlight">WHERE api_key = 'xxx'</code> 的执行时间从数秒降至毫秒级，显著提升API监控类查询性能。</p>
        </div>

        <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">3.3 为 response 字段建立全文索引（可选）</h3>
            <p class="mb-3">对于 <code class="highlight">response LIKE \"%服务异常%\"</code> 等模糊查询，B-tree索引无效。若系统支持全文检索（如MySQL的FULLTEXT），建议创建全文索引：</p>
            <div class="code-block">
                ALTER TABLE ods_telemetry.cai_api_use ADD FULLTEXT(response);
            </div>
            <p class="mt-2">改写查询为：</p>
            <div class="code-block">
                SELECT * FROM ods_telemetry.cai_api_use WHERE MATCH(response) AGAINST('服务异常' IN NATURAL LANGUAGE MODE);
            </div>
            <p class="mt-2"><span class="badge badge-medium">注意</span>：全文索引仅适用于MyISAM或InnoDB（MySQL 5.6+），且对中文支持需配置分词器。若不支持，建议通过日志分析系统（如ELK）处理此类文本搜索需求，避免直接在数据库中执行。</p>
        </div>

        <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">3.4 综合建议</h3>
            <p class="mb-3">建议优先创建 <code class="highlight">idx_cai_api_use_update_time</code> 和 <code class="highlight">idx_cai_api_use_api_key</code> 两个索引，预计可解决80%以上的慢查询问题。创建索引后，需监控查询执行计划（EXPLAIN）验证索引是否生效。</p>
        </div>
    </div>

    <section class="section-header">
        <h2 class="text-2xl font-bold text-gray-800">4. 查询改写规范</h2>
    </section>
    <div class="card">
        <p class="mb-4">为从根本上杜绝慢查询产生，制定以下强制性查询改写规范，所有开发与运维人员必须遵守：</p>

        <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">4.1 禁止使用 SELECT *</h3>
            <p class="mb-3">所有查询必须显式指定所需字段，禁止使用 <code class="highlight">SELECT *</code>。即使当前需要所有字段，也应明确列出，以避免因表结构变更导致性能波动。</p>
            <div class="code-block">
                <!-- 错误示例 -->
                SELECT * FROM cai_api_use WHERE api_key="xxx";
                
                <!-- 正确示例 -->
                SELECT update_time, user_name, api_key, response FROM cai_api_use WHERE api_key="xxx";
            </div>
        </div>

        <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">4.2 添加 LIMIT 限制</h3>
            <p class="mb-3">所有用于前端展示或调试的查询，必须添加 <code class="highlight">LIMIT</code> 限制，防止返回海量数据。</p>
            <div class="code-block">
                <!-- 错误示例 -->
                SELECT * FROM cai_api_use WHERE response LIKE \"%异常%\" ORDER BY update_time DESC;
                
                <!-- 正确示例 -->
                SELECT update_time, user_name, response FROM cai_api_use WHERE response LIKE \"%异常%\" ORDER BY update_time DESC LIMIT 100;
            </div>
        </div>

        <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">4.3 使用分区字段进行范围过滤</h3>
            <p class="mb-3">若表按时间分区（如按天），查询必须包含时间范围过滤条件，避免全表扫描。</p>
            <div class="code-block">
                <!-- 错误示例 -->
                SELECT MIN(full_question), MAX(full_question) FROM ods_telemetry.cai_api_use;
                
                <!-- 正确示例 -->
                SELECT MIN(full_question), MAX(full_question) FROM ods_telemetry.cai_api_use 
                WHERE update_time >= '2025-12-11 00:00:00' AND update_time < '2025-12-12 00:00:00';
            </div>
            <p class="mt-2">此规范可将扫描数据量从数亿行降至数百万行，性能提升百倍以上。</p>
        </div>

        <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">4.4 避免前导通配符模糊查询</h3>
            <p class="mb-3">禁止使用 <code class="highlight">LIKE \"%xxx\"</code> 模式。如需文本搜索，应使用全文索引或外部搜索引擎。</p>
            <div class="code-block">
                <!-- 错误示例 -->
                SELECT * FROM cai_api_use WHERE response LIKE \"%服务异常%\";

                <!-- 推荐替代方案 -->
                -- 使用全文索引（如上）
                -- 或在应用层进行日志聚合分析
            </div>
        </div>
    </div>

    <section class="section-header">
        <h2 class="text-2xl font-bold text-gray-800">5. 性能监控建议</h2>
    </section>
    <div class="card">
        <p class="mb-4">为持续保障数据库性能，建议建立以下监控机制：</p>

        <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">5.1 建立慢查询自动告警</h3>
            <p class="mb-3">配置数据库监控系统（如Prometheus + Grafana），对以下指标设置告警阈值：</p>
            <ul class="list-disc list-inside mb-3 ml-6">
                <li>单次查询执行时间 > 5秒</li>
                <li>单次扫描字节数 > 1GB</li>
                <li>单次扫描行数 > 100万行</li>
                <li>SELECT * 查询占比 > 10%</li>
            </ul>
            <p class="mt-2">告警应推送至开发与DBA团队，确保问题在发生后15分钟内响应。</p>
        </div>

        <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">5.2 定期执行查询分析</h3>
            <p class="mb-3">每周执行一次慢查询分析，生成类似本报告的分析结果，重点关注：</p>
            <ul class="list-disc list-inside mb-3 ml-6">
                <li>Top 10慢查询变化趋势</li>
                <li>新出现的SELECT * 查询</li>
                <li>扫描数据量异常增长的表</li>
                <li>用户行为模式变化（如root用户查询激增）</li>
            </ul>
            <p class="mt-2">分析结果应纳入团队周会，推动持续优化。</p>
        </div>

        <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">5.3 建立查询审批流程</h3>
            <p class="mb-3">对生产环境的复杂查询（如涉及JOIN、子查询、聚合函数）建立代码审查机制，要求开发人员提交执行计划（EXPLAIN）和预期扫描数据量，由DBA审核通过后方可上线。</p>
        </div>

        <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">5.4 数据归档与分区策略</h3>
            <p class="mb-3">建议对 <code class="highlight">ods_telemetry.cai_api_use</code> 表实施分区策略（按update_time按月分区），并建立冷热数据分离机制：</p>
            <ul class="list-disc list-inside mb-3 ml-6">
                <li>保留最近3个月数据在热存储</li>
                <li>超过3个月的数据归档至低成本存储</li>
                <li>定期清理无用历史数据</li>
            </ul>
            <p class="mt-2">此策略可将主表数据量从数亿行降至数千万行，从根本上解决大表扫描问题。</p>
        </div>
    </div>

    <section class="section-header">
        <h2 class="text-2xl font-bold text-gray-800">6. 总结与展望</h2>
    </section>
    <div class="card">
        <p class="mb-4">本次分析揭示了当前数据库性能瓶颈的根源：不规范的查询编写习惯与缺乏索引策略的共同作用。核心问题集中在 <code class="highlight">ods_telemetry.cai_api_use</code> 表，其大文本字段与高频访问模式使其成为性能黑洞。</p>
        
        <p class="mb-4">通过实施本报告提出的三大优化措施——<span class="highlight">索引优化</span>、<span class="highlight">查询规范</span>与<span class="highlight">监控机制</span>，预计可将慢查询数量减少80%以上，系统响应时间降低70%。</p>
        
        <p class="mb-4">建议技术团队立即行动：</p>
        <ol class="list-decimal list-inside mb-4 ml-6">
            <li>在72小时内为 <code class="highlight">update_time</code> 和 <code class="highlight">api_key</code> 创建索引</li>
            <li>发布并强制执行《数据库查询规范V1.0》</li>
            <li>在下周一前完成慢查询监控告警配置</li>
        </ol>
        
        <p class="mb-4">数据库性能优化不是一次性任务，而是持续的工程实践。唯有建立规范、培养意识、落实监控，才能构建稳定、高效的数据服务基石。</p>
    </div>

    <section class="section-header">
        <h2 class="text-2xl font-bold text-gray-800">参考文献</h2>
    </section>
    <div class="card">
        <ol>
            <li><cite><a href="https://dev.mysql.com/doc/refman/8.0/en/optimization.html" target="_blank" rel="noopener noreferrer">MySQL 8.0 Optimization</a></cite></li>
            <li><cite><a href="https://dev.mysql.com/doc/refman/8.0/en/fulltext-search.html" target="_blank" rel="noopener noreferrer">MySQL Full-Text Search</a></cite></li>
            <li><cite><a href="https://dev.mysql.com/doc/refman/8.0/en/partitioning.html" target="_blank" rel="noopener noreferrer">MySQL Partitioning</a></cite></li>
            <li><cite><a href="https://www.percona.com/blog/2020/05/11/why-select-is-bad/" target="_blank" rel="noopener noreferrer">Why SELECT * Is Bad</a></cite></li>
            <li><cite><a href="https://www.postgresql.org/docs/current/indexes-types.html" target="_blank" rel="noopener noreferrer">PostgreSQL Index Types</a></cite></li>
        </ol>
    </div>

    <footer class="footer">
        Created by Autobots<br>
        页面内容均由 AI 生成，仅供参考
    </footer>

    <script>
        // 为可折叠内容添加交互
        document.querySelectorAll('.collapsible').forEach(item => {
            item.addEventListener('click', function() {
                this.classList.toggle('active');
            });
        });
    </script>
</body>
</html>
